#!/usr/bin/env node

"use strict";

require("colors");
const optimist = require("optimist");
const argv = optimist
    .usage("$0 [-h][-m][-s] <input>".yellow)
    .option("h", {
      alias: "help",
      description: "Show usage"
    })
    .option("m", {
      alias: "meta",
      description: "Update meta data"
    })
    .option("s", {
      alias: "screenshot",
      description: "Create screenshots"
    })
    .boolean(["h", "m", "s"])
    .check((argv) => {
      if (argv.help)
        throw "";
      
      if (argv._.length === 0)
        throw "No input directory specified";
    })
    .argv;

const MetaDataSync = require("./lib/sync").MetaDataSync;
const server = require("./lib/server");

const inputDir = argv._[0];
let metaSync = new MetaDataSync(inputDir);
let filenames = metaSync.sync();
if (argv.meta) {
  filenames = filenames.then((filenames) => metaSync.syncMetaData(filenames));
}
if (argv.screenshot) {
  filenames = filenames.then((filenames) => metaSync.createScreenshots(filenames));
}
filenames
    .then(() => server.createServer(inputDir, metaSync))
    .catch((err) => console.error(`Bootstrap error: ${err.stack}`.red));
